<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cerbi — Document</title>
  <link rel="stylesheet" href="../styles/cerbi-theme.css" />
  <link rel="stylesheet" href="../styles/cerbi-fixes.css" />
  <style>
    :root{--pad:22px}
    main{max-width:900px;margin:calc(var(--nav-h,64px) + 24px) auto 80px;padding:0 16px}
    .doc{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:var(--pad)}
    .doc h1,.doc h2,.doc h3{letter-spacing:.01em}
    .doc pre{overflow:auto;background:rgba(0,0,0,.4);padding:12px;border-radius:10px}
    .doc a{color:var(--accent)}
    .error{padding:16px;border-radius:10px;background:#2b1a1a;border:1px solid #593030}
  </style>
</head>
<body>
  <main class="container">
    <article id="md" class="doc">Loading…</article>
  </main>

  <!-- Marked (MD -> HTML) + DOMPurify (sanitize) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
  <script>
  (async function () {
    const box = document.getElementById('md');
    const params = new URLSearchParams(location.search);
    let file = params.get('file') || '/docs/index.html';

    // Normalize to root-absolute so /docs/viewer.html works with /docs/*
    if (!file.startsWith('/')) file = '/' + file;

    async function tryFetch(url) {
      try {
        const res = await fetch(url, { cache: 'no-cache' });
        if (!res.ok) return null;
        const text = await res.text();
        return { url, text };
      } catch (_) {
        return null;
      }
    }

    // Build candidate URLs in order of likelihood
    const candidates = [ file ];
    if (file.endsWith('.md')) {
      candidates.push(file.replace(/\.md$/, '.html')); // /docs/x.html
      candidates.push(file.replace(/\.md$/, ''));      // /docs/x
      candidates.push(file.replace(/\.md$/, '/'));     // /docs/x/
    }

    // Try each candidate until one works
    let hit = null;
    for (const u of candidates) {
      hit = await tryFetch(u);
      if (hit) break;
    }

    if (!hit) {
      box.innerHTML = '<div class="error">Could not load document.</div>';
      return;
    }

    const { url, text } = hit;

    // If what we fetched is a full HTML document, navigate to it (don’t nest <html> inside)
    if (/^\s*<!DOCTYPE html>|<html[\s>]/i.test(text)) {
      location.replace(url);
      return;
    }

    // Otherwise, render Markdown safely
    if (window.marked && window.DOMPurify) {
      box.innerHTML = DOMPurify.sanitize(marked.parse(text));
    } else {
      const esc = s => s.replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
      box.innerHTML = '<pre>' + esc(text) + '</pre>';
    }
  })();
  </script>
</body>
</html>
